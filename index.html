<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>Sexy Slots</title>

<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-180.png">
<link rel="manifest" href="manifest.webmanifest">

<style>
:root{
  --bg:#0b0b0d; --panel:#141419; --panel2:#1a1a22; --line:#242432;
  --text:#f5f5f7; --muted:#b8b8c0; --gold:#e2b94b; --pink:#ff3b66;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{
  height:100%; margin:0; background:var(--bg); color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro",Roboto,system-ui,sans-serif;
  overflow:auto; touch-action:manipulation;
}
button{border:0;background:none;color:inherit;font:inherit;cursor:pointer;touch-action:manipulation}
input,select{background:var(--panel);color:var(--text);border:1px solid var(--line);border-radius:10px;padding:.5em .7em;min-height:44px}
.safe{height:calc(env(safe-area-inset-top) + 0.2cm)}
.hidden{display:none!important}

/* header */
header{
  position:sticky; top:0; z-index:30; display:flex; align-items:center; justify-content:space-between;
  padding:.25rem .6rem; background:rgba(0,0,0,.85); backdrop-filter:blur(8px); border-bottom:1px solid var(--line)
}
.hamb{width:44px;height:44px;display:grid;place-items:center;border-radius:10px}
.title{
  font-weight:900; letter-spacing:.3px;
  background:linear-gradient(180deg,#fff,#e8e8f2 45%,#c9c9d9);
  -webkit-background-clip:text; background-clip:text; color:transparent;
  text-shadow:0 1px 0 rgba(255,255,255,.25), 0 6px 18px rgba(226,185,75,.12);
  position:relative;
}
header.rig .title{
  background:linear-gradient(180deg,#ffd86a,#e2b94b 50%,#b8922f);
  -webkit-background-clip:text; background-clip:text; color:transparent;
  text-shadow:0 6px 18px rgba(226,185,75,.25);
}
.title::after{
  content:""; position:absolute; left:50%; transform:translateX(-50%);
  bottom:-6px; width:64px; height:3px; border-radius:3px;
  background:linear-gradient(90deg,transparent,#e2b94b,transparent); opacity:.7;
}

/* controls */
.controls{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem;padding:.6rem}
.ctrl{background:var(--panel2);border-radius:12px;min-height:44px;display:flex;align-items:center;justify-content:center;gap:.45rem}
.ctrl .pill{background:#2a2a36;border-radius:999px;padding:.05em .55em;font-size:12px;color:#ddd}
.ctrl.active{background:var(--gold);color:#000}
.spinwrap{padding:.3rem .6rem}
#spin{
  width:100%; min-height:56px; border-radius:16px;
  background:linear-gradient(180deg,#ff5078 0%,#ff3b66 40%,#c50d40 100%);
  font-weight:900; letter-spacing:.35px; color:#fff;
  box-shadow:0 10px 24px rgba(255,59,102,.25), inset 0 1px 0 rgba(255,255,255,.12);
  position:relative; overflow:hidden;
}
#spin::before{content:""; position:absolute; inset:0; background:linear-gradient(180deg,rgba(255,255,255,.18),transparent 45%); pointer-events:none;}
#spin:active{ transform:translateY(1px); box-shadow:0 8px 16px rgba(255,59,102,.22), inset 0 1px 0 rgba(255,255,255,.05); }
#spin[disabled]{opacity:.4}

/* reels */
.reels{display:grid;grid-template-columns:repeat(3,1fr);gap:.6rem;padding:.5rem .6rem}
.reel{height:92px;background:var(--panel2);border-radius:12px;overflow:hidden;position:relative}
.reel .inner{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;will-change:transform,filter}
.reel .inner.blur{filter:blur(2px)}
.reel img{width:100%;height:100%;object-fit:cover}

/* reveal */
.reveal{flex:1;display:flex;flex-direction:column;overflow:auto; -webkit-overflow-scrolling:touch;}
.name{padding:.45rem .9rem;text-align:center;font-weight:800}
.big{flex:1;display:grid;place-items:center;padding:.2rem .7rem}
.big img{width:100%;max-height:54vh;object-fit:contain;border-radius:14px;background:#0e0e12}
.meters{padding:.5rem .9rem 1rem;display:flex;flex-direction:column;gap:.35rem}
.meter{display:flex;align-items:center;justify-content:space-between;background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:.55rem .8rem}
.meter .label{color:var(--muted)}
.stars{color:var(--gold);letter-spacing:1px}

/* timer */
.tbar{position:sticky;bottom:0;background:linear-gradient(180deg,transparent,rgba(0,0,0,.75));padding:.6rem .6rem 1rem}
.timer{background:var(--panel2);border:1px solid var(--line);border-radius:14px;padding:.5rem .6rem;display:flex;justify-content:space-between;align-items:center}
.badge{background:#262633;color:#ddd;border-radius:999px;padding:.2em .6em;font-size:12px}
.btn{background:#2a2a36;border-radius:10px;padding:.48rem .8rem}
.btn.red{background:#3a1a22;color:#ff8ea6}

/* overlays */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.92);backdrop-filter:blur(8px);z-index:100;display:none}
.overlay.show{display:block}
.sheet{position:absolute;inset:calc(env(safe-area-inset-top) + 1rem) .6rem 1rem;background:var(--panel2);border:1px solid var(--line);border-radius:16px;display:flex;flex-direction:column;overflow:hidden}
.sheet>header{display:flex;align-items:center;gap:.5rem;justify-content:space-between;padding:.55rem;border-bottom:1px solid var(--line)}
.sheet .content{flex:1;min-height:0;overflow:auto;padding:.6rem; -webkit-overflow-scrolling:touch;}
.small{font-size:12px;color:#b8b8c0}

/* settings */
.filters{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.6rem}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
.card{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden}
.thumb{position:relative;height:120px;background:#0d0d12}
.thumb img{width:100%;height:100%;object-fit:cover}
.catbadge{position:absolute;left:6px;top:6px;background:var(--gold);color:#000;border-radius:8px;padding:2px 6px;font-size:12px}
.inctgl{position:absolute;right:6px;top:6px;background:#2a2a36;border-radius:999px;padding:2px 8px;font-size:12px}
.inctgl.off{background:#71222a;color:#ff9bb0}
.body{padding:.5rem;display:flex;flex-direction:column;gap:.35rem}
.starrow{display:flex;align-items:center;gap:.25rem}
.starrow .s{width:28px;height:28px;border-radius:8px;background:#2a2a36;display:grid;place-items:center}
.starrow .lit{color:var(--gold)}
.card.bulk{outline:2px dashed var(--gold); outline-offset:2px}

/* rig */
.flowtabs{display:grid;grid-template-columns:repeat(7,1fr);gap:.35rem}
.flowtabs button{background:#2a2a36;border-radius:10px;padding:.45rem 0}
.flowtabs .on{background:var(--gold);color:#000;font-weight:800}
.flowlist{display:flex;gap:.35rem;flex-wrap:wrap;margin:.45rem 0}
.flowpill{background:#1d1d28;border:1px dashed #3a3a48;border-radius:999px;padding:.25rem .6rem;display:flex;gap:.35rem;align-items:center}
.flowpill .x{background:#3a1a22;color:#ff98ad;border-radius:50%;width:18px;height:18px;display:grid;place-items:center;font-size:12px}
.weights{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
.wcard{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:.6rem}
.whead{display:flex;justify-content:space-between;align-items:center;margin-bottom:.45rem}
.wbar{display:flex;gap:.4rem;align-items:center}
.wbtn{background:#2a2a36;border-radius:8px;width:34px;height:34px;display:grid;place-items:center}

/* util */
.toast{position:fixed;left:50%;bottom:18vh;transform:translateX(-50%);background:#111;border:1px solid var(--line);padding:10px 14px;border-radius:12px;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,.36)}
</style>
</head>
<body>
<div class="safe" aria-hidden="true"></div>
<header id="hdr">
  <button class="hamb" id="btnSettings">☰</button>
  <div class="title">Sexy Slots</div>
  <div style="width:44px"></div>
</header>

<div class="controls">
  <button class="ctrl" id="oralCtrl">Oral <span class="pill" id="oralPill">OFF</span></button>
  <button class="ctrl" id="catCtrl">Category <span class="pill" id="catPill">All</span></button>
  <button class="ctrl" id="timeCtrl">Timer <span class="pill" id="timePill">Off</span></button>
</div>

<div class="controls">
  <button class="ctrl" id="diffCtrl">Difficulty <span class="pill" id="diffPill">All</span></button>
  <button class="ctrl" id="heroCtrl">Her-O <span class="pill" id="heroPill">All</span></button>
  <button class="ctrl" id="hisoCtrl">His-O <span class="pill" id="hisoPill">All</span></button>
</div>

<div class="spinwrap"><button id="spin">SPIN</button></div>

<div class="reels">
  <div class="reel"><div class="inner" id="reel1"><img alt=""></div></div>
  <div class="reel"><div class="inner" id="reel2"><img alt=""></div></div>
  <div class="reel"><div class="inner" id="reel3"><img alt=""></div></div>
</div>

<div class="reveal">
  <div class="name" id="revName">Position</div>
  <div class="big"><img id="revImg" alt=""></div>
  <div class="meters" id="meters">
    <div class="meter"><div class="label" id="difficultyLabel">Difficulty</div><div class="stars" id="mDiff">☆☆☆☆☆</div></div>
    <div class="meter"><div class="label">Her‑O Meter</div><div class="stars" id="mHer">☆☆☆☆☆</div></div>
    <div class="meter"><div class="label">His‑O Meter</div><div class="stars" id="mHis">☆☆☆☆☆</div></div>
  </div>

  <!-- Hidden Description (per-image) -->
  <div class="desc" id="descBox" style="padding:0 .9rem 1rem;">
    <button class="btn" id="descToggle">Show description</button>
    <div class="desc-body hidden" id="descBody" style="margin-top:.5rem;">
      <div id="descText" class="desc-text small" style="white-space:pre-wrap;line-height:1.35;border:1px solid var(--line);background:var(--panel);border-radius:12px;padding:.6rem;"></div>
      <div class="desc-edit hidden" id="descEdit" style="margin-top:.5rem;">
        <textarea id="descArea" rows="4" style="width:100%;border-radius:12px;border:1px solid var(--line);background:var(--panel);color:var(--text);padding:.6rem;"></textarea>
        <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.4rem">
          <button class="btn" id="descCancel">Cancel</button>
          <button class="btn" id="descSave">Save</button>
        </div>
      </div>
      <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.4rem">
        <button class="btn" id="descEditBtn">Edit</button>
      </div>
    </div>
  </div>

  <div class="tbar hidden" id="tbar">
    <div class="timer">
      <div><span class="badge" id="tBadge">0:00</span> <span class="small" id="tNote">Timer running…</span></div>
      <div>
        <button class="btn" id="tSkip">Skip</button>
        <button class="btn red" id="tCancel">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS -->
<div class="overlay" id="settings">
  <div class="sheet">
    <header>
      <div style="display:flex;gap:.5rem;align-items:center">
        <button class="btn" id="btnUpload">Upload</button>
        <button class="btn" id="btnRig">Rig</button>
      </div>
      <div class="small">Settings</div>
      <button class="btn" id="btnCloseSettings">Close</button>
    </header>
    <div class="content">
      <div class="filters">
        <select id="fCat"></select>
        <button class="btn" id="fW0">Hide weight=0</button>
        <select id="bulkCat"></select>
        <button class="btn" id="bulkApply">Tap-to-Apply</button>

        <!-- Repo loader actions -->
        <button class="btn" id="repoResetLoad" title="Clear local data then import from CSV">Reset & Load from CSV</button>
        <button class="btn" id="repoMergeLoad" title="Merge CSV rows into current library">Reload from CSV (merge)</button>
      </div>
      <div class="grid" id="cards"></div>
    </div>
  </div>
</div>

<!-- RIG MENU -->
<div class="overlay" id="rig">
  <div class="sheet">
    <header>
      <div class="small">Rig Menu</div>
      <button class="btn" id="btnCloseRig">Close</button>
    </header>
    <div class="content">
      <div class="section">
        <div class="flowtabs" id="flowTabs"></div>
        <div class="flowlist" id="flowList"></div>
        <div class="small">Tap items to remove. Use “Add to Flow”.</div>
      </div>
      <div style="height:1px;background:var(--line);margin:.6rem 0"></div>
      <div class="section">
        <div class="weights" id="weights"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== State & Persistence ===== */
const CATS=["Missionary","Woman-on-top","Oral for Her","Oral for Him","Sitting","Standing","Side-by-Side","Deep Penetration","69","Rear Entry","BDSM for Lovers","Adventurous"];
const ALL_CATS=["All","Unassigned",...CATS];
const PIN="1616";
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
let idb; let meta={}; // id->{...}
let state={oralOnly:false,category:"All",difficulty:0,hero:0,hiso:0,timerMin:0,rig:false,flows:[[],[],[],[],[],[],[]],flowIndex:0,fCat:"All",fW0:false,bulkCat:"",bulkMode:false};
let currentId=null;
const LSK="ss_meta_v1", LSS="ss_state_v1";
function saveMeta(){localStorage.setItem(LSK,JSON.stringify(meta));}
function loadMeta(){try{meta=JSON.parse(localStorage.getItem(LSK)||"{}");}catch{meta={};}}
function saveState(){localStorage.setItem(LSS,JSON.stringify(state));$("#hdr").classList.toggle("rig",state.rig);}
function loadState(){try{Object.assign(state,JSON.parse(localStorage.getItem(LSS)||"{}"));}catch{};$("#hdr").classList.toggle("rig",state.rig);}

/* ===== IndexedDB ===== */
function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open("SexySlotsDB",1);
  r.onupgradeneeded=e=>{const db=e.target.result;if(!db.objectStoreNames.contains("images"))db.createObjectStore("images",{keyPath:"id"});};
  r.onsuccess=()=>{idb=r.result;res();}; r.onerror=()=>rej(r.error);});}
function idbPut(id,blob){return new Promise((res,rej)=>{const tx=idb.transaction("images","readwrite");tx.objectStore("images").put({id,blob});tx.oncomplete=res;tx.onerror=()=>rej(tx.error);});}
function idbGet(id){return new Promise((res,rej)=>{const tx=idb.transaction("images","readonly");const g=tx.objectStore("images").get(id);g.onsuccess=()=>res(g.result);g.onerror=()=>rej(g.error);});}
function idbDel(id){return new Promise((res,rej)=>{const tx=idb.transaction("images","readwrite");tx.objectStore("images").delete(id);tx.oncomplete=res;tx.onerror=()=>rej(tx.error);});}

/* ===== Upload (100+ with progress) ===== */
$("#btnUpload").addEventListener("click",()=>{const inp=document.createElement("input");inp.type="file";inp.accept="image/*";inp.multiple=true;inp.onchange=()=>{if(inp.files?.length) batchImport(Array.from(inp.files));};inp.click();});
function makeId(){try{return crypto.randomUUID();}catch{return Date.now()+"-"+Math.random().toString(16).slice(2);}}
async function batchImport(files){
  const ov=document.createElement("div");ov.style.cssText="position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,.92);display:flex;align-items:center;justify-content:center;color:#fff;";
  ov.innerHTML=`<div style="background:#1c1c22;border:1px solid #2a2a36;padding:16px 18px;border-radius:12px;min-width:260px;text-align:center">
  <div id="ptext" style="margin-bottom:10px">Preparing…</div>
  <div style="height:8px;background:#2a2a36;border-radius:6px;overflow:hidden"><div id="pbar" style="height:100%;width:0;background:#e2b94b"></div></div>
  <button id="pcancel" class="btn red" style="margin-top:12px;width:100%">Cancel</button></div>`;
  document.body.appendChild(ov);
  let cancelled=false; ov.querySelector("#pcancel").onclick=()=>{cancelled=true;};
  const ptext=ov.querySelector("#ptext"), pbar=ov.querySelector("#pbar");
  let done=0, ok=0;
  for(const f of files){ if(cancelled) break;
    done++; ptext.textContent=`Importing ${done} of ${files.length}…`; pbar.style.width=Math.round(done/files.length*100)+"%";
    try{const id=makeId(); await idbPut(id,f);
      meta[id]={id,name:(f.name||"").replace(/\.[^.]+$/,""),category:"",difficulty:3,hero:3,hiso:3,weight:1,exclude:false,desc:""}; ok++;
      await new Promise(r=>requestAnimationFrame(r));
    }catch(e){console.warn("Import fail",e);}
  }
  saveMeta(); document.body.removeChild(ov); toast(cancelled?`Cancelled (${ok} saved)`:`Imported ${ok}`); renderSettings(); renderWeights();
}

/* ===== Settings & Filters ===== */
$("#btnSettings").addEventListener("click",openSettings);
$("#btnCloseSettings").addEventListener("click",()=>$("#settings").classList.remove("show"));
function openSettings(){ $("#settings").classList.add("show"); fillSelect($("#fCat"),ALL_CATS,state.fCat); $("#fW0").classList.toggle("active",state.fW0); fillSelect($("#bulkCat"),["",...CATS],state.bulkCat); renderSettings(); }
$("#fCat").addEventListener("change",e=>{state.fCat=e.target.value;saveState();renderSettings();});
$("#fW0").addEventListener("click",()=>{state.fW0=!state.fW0;saveState();$("#fW0").classList.toggle("active",state.fW0);renderSettings();});
$("#bulkCat").addEventListener("change",e=>{state.bulkCat=e.target.value;saveState();});
$("#bulkApply").addEventListener("click",()=>{ if(!state.bulkMode){ if(!state.bulkCat){toast("Choose a category first");return;} state.bulkMode=true; saveState(); toast("Bulk ON: tap cards to assign"); } else { state.bulkMode=false; saveState(); toast("Bulk OFF"); } renderSettings(); });
$("#cards").addEventListener("click",(e)=>{ if(!state.bulkMode) return; const card=e.target.closest(".card"); if(!card) return; const id=card.dataset.id; meta[id].category=state.bulkCat; saveMeta(); renderSettings(); renderWeights(); });

function renderSettings(){
  const list=$("#cards"); list.innerHTML="";
  let items=Object.values(meta);
  if(state.fCat==="Unassigned") items=items.filter(m=>!m.category);
  else if(state.fCat!=="All") items=items.filter(m=>m.category===state.fCat);
  if(state.fW0) items=items.filter(m=>(m.weight|0)>0);

  for(const m of items){
    const card=el('div','card'); card.dataset.id=m.id;
    const th=el('div','thumb'); const img=el('img'); th.appendChild(img);
    if(m.category){const b=el('div','catbadge',m.category); th.appendChild(b);}
    const inc=el('div','inctgl'+(m.exclude?' off':''), m.exclude?'Excluded':'Included');
    inc.addEventListener('click',()=>{m.exclude=!m.exclude;saveMeta();renderSettings();renderWeights();});
    th.appendChild(inc); card.appendChild(th);
    getStoredBlob(m.id).then(b=>{
      if(b) img.src=URL.createObjectURL(b);
      else{ const miss=document.createElement('div'); miss.className='catbadge'; miss.style.background='#71222a'; miss.style.color='#fff'; miss.textContent='Missing'; th.appendChild(miss); }
    });

    const body=el('div','body');
    const name=el('input'); name.value=m.name; name.addEventListener('change',()=>{m.name=name.value.trim();saveMeta();renderWeights();}); body.append(labelRow('Name',name));
    const sel=el('select'); CATS.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;if(m.category===c)o.selected=true;sel.appendChild(o);});
    sel.addEventListener('change',()=>{m.category=sel.value;saveMeta();renderSettings();renderWeights();}); body.append(labelRow('Category',sel));
    body.append(starRow('Difficulty','difficulty',m));
    body.append(starRow('Her‑O','hero',m));
    body.append(starRow('His‑O','hiso',m));
    const wbar=el('div','starrow'); const minus=btn('−',()=>{m.weight=Math.max(0,(m.weight|0)-1);saveMeta();renderSettings();renderWeights();});
    const val=el('span',null,String(m.weight|0)); const plus=btn('+',()=>{m.weight=(m.weight|0)+1;saveMeta();renderSettings();renderWeights();});
    wbar.append(text('Weight'),spacer(),minus,val,plus); body.append(wbar);
    const del=el('button','btn red','Delete'); del.style.width='100%';
    del.addEventListener('click',async()=>{if(!confirm('Delete this image?'))return;await idbDel(m.id);delete meta[m.id];saveMeta();renderSettings();renderWeights();});
    body.append(del); card.append(body); list.appendChild(card);
  }
  if(state.bulkMode){ $("#bulkApply").textContent="Exit Bulk"; $$(".card").forEach(c=>c.classList.add("bulk")); }
  else $("#bulkApply").textContent="Tap-to-Apply";
}
function starRow(label,key,m){ const row=el('div','starrow'); row.append(text(label),spacer()); for(let i=1;i<=5;i++){const b=el('div','s'+(i<=m[key]?' lit':''),'★'); b.addEventListener('click',()=>{m[key]=i;saveMeta();renderSettings();renderWeights();}); row.append(b);} return row; }
function labelRow(lbl,control){const wrap=el('div','starrow'); wrap.append(text(lbl),spacer(),control); return wrap;}

/* ===== Rig Mode ===== */
$("#difficultyLabel").addEventListener("click",()=>{state.rig=!state.rig;saveState();toast(state.rig?'Rig ON':'Rig OFF');});
$("#btnRig").addEventListener("click",()=>{const pin=prompt("Enter PIN"); if(pin===PIN){openRig();} else if(pin!=null){toast("Wrong PIN");}});
$("#btnCloseRig").addEventListener("click",()=>$("#rig").classList.remove("show"));
function openRig(){ $("#rig").classList.add("show"); renderFlowTabs(); renderFlowList(); renderWeights(); }
function renderFlowTabs(){ const ft=$("#flowTabs"); ft.innerHTML=""; for(let i=0;i<7;i++){const b=btn(String.fromCharCode(65+i),()=>{state.flowIndex=i;saveState();renderFlowTabs();renderFlowList();}); if(i===state.flowIndex)b.classList.add('on'); ft.appendChild(b);} }
function renderFlowList(){ const fl=$("#flowList"); fl.innerHTML=""; const arr=state.flows[state.flowIndex]; arr.forEach((id,idx)=>{const pill=el('div','flowpill',meta[id]?.name||'unknown'); const x=el('div','x','×'); x.addEventListener('click',()=>{arr.splice(idx,1);saveState();renderFlowList();}); pill.appendChild(x); fl.appendChild(pill);}); }
function renderWeights(){
  const w=$("#weights"); if(!w) return; w.innerHTML="";
  Object.values(meta).forEach(m=>{
    const card=el('div','wcard');
    const head=el('div','whead'); head.append(el('span','small',m.category||'Unassigned'));
    const inc=el('div','inctgl'+(m.exclude?' off':''), m.exclude?'Excluded':'Included'); inc.addEventListener('click',()=>{m.exclude=!m.exclude;saveMeta();renderWeights();}); head.append(inc); card.append(head);
    const bar=el('div','wbar');
    const minus=el('button','wbtn','−'), plus=el('button','wbtn','+'), val=el('span',null,m.weight|0);
    minus.addEventListener('click',()=>{m.weight=Math.max(0,(m.weight|0)-1);val.textContent=m.weight;saveMeta();});
    plus.addEventListener('click',()=>{m.weight=(m.weight|0)+1;val.textContent=m.weight;saveMeta();});
    const add=btn('Add to Flow',()=>{const arr=state.flows[state.flowIndex]; if(arr.length>=6){toast('Flow full (6)');return;} if(!arr.includes(m.id)){arr.push(m.id);saveState();renderFlowList();}});
    bar.append(minus,val,plus,add);
    const foot=el('div','small',`Weight: ${m.weight} • ${m.name||'Untitled'}`);
    card.append(bar,foot); w.appendChild(card);
  });
}

/* ===== Spin + animation + timer + sound ===== */
let spinning=false, timerId=null, remain=0;
$("#spin").addEventListener("click",()=>{ if(!spinning && !timerId) spin(); });

function poolNow(){ let arr=Object.values(meta).filter(m=>!m.exclude && (m.weight|0)>0);
  if(state.oralOnly) arr=arr.filter(m=>m.category==="Oral for Her"||m.category==="Oral for Him");
  if(state.category==="Unassigned") arr=arr.filter(m=>!m.category);
  else if(state.category!=="All") arr=arr.filter(m=>m.category===state.category);
  if(state.difficulty) arr=arr.filter(m=>m.difficulty===state.difficulty);
  if(state.hero) arr=arr.filter(m=>m.hero===state.hero);
  if(state.hiso) arr=arr.filter(m=>m.hiso===state.hiso);
  return arr;
}
function weighted(arr){ const sum=arr.reduce((a,b)=>a+(b.weight|0),0); let r=Math.random()*sum; for(const x of arr){ r-=(x.weight|0); if(r<=0) return x; } return arr[0]; }
function randOther(pool,notId){ const cand=pool.filter(m=>m.id!==notId); return (cand[Math.floor(Math.random()*cand.length)]||pool[0]||{id:notId}).id; }

function spin(){
  const pool=poolNow(); if(pool.length===0){toast("No images match filters");return;}
  let chosen; if(state.rig && state.flows[state.flowIndex].length){ const id=state.flows[state.flowIndex].shift(); chosen=meta[id]; saveState(); renderFlowList(); } else { chosen=weighted(pool); }

  spinning=true; $("#spin").disabled=true;
  const reels=[$("#reel1"),$("#reel2"),$("#reel3")];
  const dur=[5400,6000,5700]; const ids=pool.map(m=>m.id); if(!ids.length) ids.push(chosen.id);
  const stopIds=[randOther(pool,chosen.id), chosen.id, randOther(pool,chosen.id)];
  reels.forEach(r=>r.classList.add("blur"));

  const start=performance.now(); const speed0=26;
  function step(now){
    const t=now-start;
    reels.forEach((reel,i)=>{
      const d=dur[i]; const p=Math.min(1,t/d); const ease=1-Math.pow(1-p,3);
      const ms=speed0+ease*140;
      if(!reel._next || now>reel._next){
        reel._next=now+ms;
        const randid=ids[Math.floor(Math.random()*ids.length)]||chosen.id;
        getStoredBlob(randid).then(b=>{ if(b) reel.querySelector('img').src=URL.createObjectURL(b); });
      }
      if(p>=1){
        getStoredBlob(stopIds[i]).then(b=>{ if(b) reel.querySelector('img').src=URL.createObjectURL(b); });
        reel.classList.remove("blur");
      }
    });
    if(t<Math.max(...dur)) requestAnimationFrame(step); else finishSpin(chosen);
  }
  requestAnimationFrame(step);

  unlockAudioOnce(); spinTick();
}

function finishSpin(m){
  $("#revName").textContent=m.name||"Untitled";
  $("#mDiff").textContent="★".repeat(m.difficulty||1)+"☆".repeat(5-(m.difficulty||1));
  $("#mHer").textContent="★".repeat(m.hero||1)+"☆".repeat(5-(m.hero||1));
  $("#mHis").textContent="★".repeat(m.hiso||1)+"☆".repeat(5-(m.hiso||1));
  getStoredBlob(m.id).then(b=>{ if(b) $("#revImg").src=URL.createObjectURL(b); });
  currentId=m.id; populateDesc();
  spinning=false;
  if(state.timerMin>0) startTimer(state.timerMin*60);
  else $("#spin").disabled=false;
}

/* timer */
function startTimer(s){ if(timerId) clearInterval(timerId); remain=s|0; $("#tbar").classList.remove("hidden"); tickTimer(); timerId=setInterval(tickTimer,1000); }
function tickTimer(){ const mm=Math.floor(remain/60), ss=(remain%60).toString().padStart(2,'0'); $("#tBadge").textContent=`${mm}:${ss}`; remain--; if(remain<0){ clearInterval(timerId); timerId=null; $("#tbar").classList.add("hidden"); chime(); $("#spin").disabled=false; } }
$("#tSkip").addEventListener("click",()=>{ if(!timerId)return; clearInterval(timerId); timerId=null; $("#tbar").classList.add("hidden"); $("#spin").disabled=false; });
$("#tCancel").addEventListener("click",()=>{ if(!timerId)return; clearInterval(timerId); timerId=null; $("#tbar").classList.add("hidden"); });

/* sounds */
let ac, audioReady=false;
function unlockAudioOnce(){ if(audioReady) return; try{ ac=new (window.AudioContext||window.webkitAudioContext)(); const s=ac.createOscillator(), g=ac.createGain(); g.gain.value=0; s.connect(g); g.connect(ac.destination); s.start(); s.stop(ac.currentTime+0.01); audioReady=true; }catch{} }
function spinTick(){ if(!ac) return; const o=ac.createOscillator(), g=ac.createGain(); o.type='triangle'; o.frequency.value=240; g.gain.value=.05; o.connect(g); g.connect(ac.destination); o.start(); o.stop(ac.currentTime+.08); }
function chime(){ if(!ac) return; const o=ac.createOscillator(), g=ac.createGain(); o.type='sine'; o.frequency.setValueAtTime(880, ac.currentTime); g.gain.value=.12; o.connect(g); g.connect(ac.destination); o.start(); o.stop(ac.currentTime+.22); }

/* top controls + pickers */
$("#oralCtrl").addEventListener("click",()=>{state.oralOnly=!state.oralOnly;$("#oralPill").textContent=state.oralOnly?'ON':'OFF';saveState();});
$("#catCtrl").addEventListener("click",showCategoryPicker);
$("#diffCtrl").addEventListener("click",()=>showRatingPicker('difficulty','Difficulty','#diffPill'));
$("#heroCtrl").addEventListener("click",()=>showRatingPicker('hero','Her-O','#heroPill'));
$("#hisoCtrl").addEventListener("click",()=>showRatingPicker('hiso','His-O','#hisoPill'));
function showRatingPicker(key,label,pill){
  const ov=document.createElement('div'); ov.className='overlay show';
  const sheet=document.createElement('div'); sheet.className='sheet'; sheet.style.inset='calc(env(safe-area-inset-top) + 2rem) .8rem 1.2rem';
  sheet.innerHTML=`<header><div class="small">Choose ${label}</div><button class="btn" id="rpClose">Close</button></header><div class="content" id="rpList"></div>`;
  ov.appendChild(sheet); document.body.appendChild(ov);
  $("#rpClose").onclick=()=>ov.remove();
  const list=$("#rpList"); const opts=[0,1,2,3,4,5];
  opts.forEach(v=>{ const b=document.createElement('button'); b.className='btn'; b.style.cssText='display:block;width:100%;text-align:left;margin:.25rem 0'; const txt=v===0?'All':v; b.textContent=(state[key]===v?'✓ ':'')+txt; b.onclick=()=>{state[key]=v; saveState(); document.querySelector(pill).textContent=txt; ov.remove();}; list.appendChild(b); });
}
function showCategoryPicker(){
  const ov=document.createElement('div'); ov.className='overlay show';
  const sheet=document.createElement('div'); sheet.className='sheet'; sheet.style.inset='calc(env(safe-area-inset-top) + 2rem) .8rem 1.2rem';
  sheet.innerHTML=`<header><div class="small">Choose Category</div><button class="btn" id="cpClose">Close</button></header><div class="content" id="cpList"></div>`;
  ov.appendChild(sheet); document.body.appendChild(ov);
  $("#cpClose").onclick=()=>ov.remove();
  const list=$("#cpList"); ALL_CATS.forEach(c=>{ const b=document.createElement('button'); b.className='btn'; b.style.cssText='display:block;width:100%;text-align:left;margin:.25rem 0'; b.textContent=(c===state.category?'✓ ':'')+c; b.onclick=()=>{state.category=c; saveState(); $("#catPill").textContent=c; ov.remove();}; list.appendChild(b); });
}
$("#timeCtrl").addEventListener("click", showTimerPicker);
function showTimerPicker(){
  const ov=document.createElement('div'); ov.className='overlay show';
  const sheet=document.createElement('div'); sheet.className='sheet'; sheet.style.inset='calc(env(safe-area-inset-top) + 2rem) .8rem 1.2rem';
  sheet.innerHTML=`<header><div class="small">Timer</div><button class="btn" id="tpClose">Close</button></header><div class="content" id="tpList"></div>`;
  ov.appendChild(sheet); document.body.appendChild(ov);
  $("#tpClose").onclick=()=>ov.remove();
  const opts=[0,1,2,3,4,5]; const list=$("#tpList");
  opts.forEach(min=>{ const b=document.createElement('button'); b.className='btn'; b.style.cssText='display:block;width:100%;text-align:left;margin:.25rem 0'; b.textContent=(state.timerMin===min?'✓ ':'')+(min?`${min} minute${min>1?'s':''}`:'Off'); b.onclick=()=>{state.timerMin=min; $("#timePill").textContent=min? (min+'m'):'Off'; saveState(); ov.remove();}; list.appendChild(b); });
}

/* Description UI */
const descToggle=$("#descToggle"), descBody=$("#descBody"),
      descText=$("#descText"), descEdit=$("#descEdit"),
      descArea=$("#descArea"), descSave=$("#descSave"),
      descCancel=$("#descCancel"), descEditBtn=$("#descEditBtn");
function populateDesc(){
  const d=(currentId && meta[currentId] && typeof meta[currentId].desc==="string")? meta[currentId].desc : "";
  descText.textContent=d||"No description yet."; descArea.value=d||"";
  descBody.classList.add("hidden"); descEdit.classList.add("hidden"); descToggle.textContent="Show description";
}
descToggle.addEventListener("click",()=>{ const open=!descBody.classList.contains("hidden"); if(open){ descBody.classList.add("hidden"); descToggle.textContent="Show description"; } else { descBody.classList.remove("hidden"); descToggle.textContent="Hide description"; }});
descEditBtn.addEventListener("click",()=>{ descEdit.classList.remove("hidden"); descArea.focus(); });
descCancel.addEventListener("click",()=>{ descEdit.classList.add("hidden"); const d=(currentId && meta[currentId])? (meta[currentId].desc||""):""; descArea.value=d; });
descSave.addEventListener("click",()=>{ if(!currentId || !meta[currentId]) return; meta[currentId].desc=(descArea.value||"").trim(); saveMeta(); descText.textContent=meta[currentId].desc||"No description yet."; descEdit.classList.add("hidden"); });

/* helpers */
function el(tag,cls,html){const e=document.createElement(tag); if(cls) e.className=cls; if(html!=null) e.innerHTML=html; return e;}
function text(t){const s=document.createElement('span'); s.textContent=t; return s;}
function spacer(){const s=document.createElement('div'); s.style.flex='1'; return s;}
function btn(label,fn){const b=document.createElement('button'); b.className='btn'; b.textContent=label; b.addEventListener('click',fn); return b;}
function fillSelect(sel,items,val){sel.innerHTML=""; items.forEach(x=>{const o=document.createElement('option'); o.value=x; o.textContent=x; if(x===val) o.selected=true; sel.appendChild(o);});}
function toast(msg){const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>{t.style.opacity='0'; t.style.transition='opacity .35s';},1300); setTimeout(()=>t.remove(),1850);}

/* ===== CSV + Image bootstrap (robust) ===== */
const CSV_PATH='data/positions.csv';
const DEFAULT_IMG_BASE='assets/positions/'; // your repo folder
let IMG_BASE=DEFAULT_IMG_BASE;
const memBlobs=new Map();

document.addEventListener('click',(e)=>{ if(e.target?.id==='repoResetLoad') hardResetAndLoadFromCSV(); if(e.target?.id==='repoMergeLoad') mergeLoadFromCSV(); });

(async function autoLoadIfEmpty(){
  await ensureDB();
  if(Object.keys(meta||{}).length===0){
    try{ await mergeLoadFromCSV(); toast('Loaded default content'); }catch(e){ console.warn('auto-load failed',e); }
  }
})();

async function ensureDB(){ if(!idb){ try{ await openDB(); }catch(e){ console.warn('IDB open failed', e); } } }
async function hardResetAndLoadFromCSV(){
  if(!confirm('Clear local data and load fresh from CSV?')) return;
  await clearLocalData(); await loadCSVAndImages({reset:true});
  toast('Loaded from CSV'); renderSettings(); renderWeights();
}
async function mergeLoadFromCSV(){ await loadCSVAndImages({reset:false}); toast('CSV merge complete'); renderSettings(); renderWeights(); }
async function clearLocalData(){
  localStorage.removeItem(LSK); localStorage.removeItem(LSS); meta={}; memBlobs.clear();
  try{ if(idb){ await new Promise((resolve,reject)=>{ const tx=idb.transaction('images','readwrite'); const req=tx.objectStore('images').clear(); req.onsuccess=()=>resolve(); req.onerror=()=>reject(req.error); }); } }catch(e){ console.warn('IDB clear failed',e); }
  saveMeta(); saveState();
}
async function loadCSVAndImages({reset=false}={}){
  const ov=document.createElement('div');
  ov.style.cssText="position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,.92);display:flex;align-items:center;justify-content:center;color:#fff;";
  ov.innerHTML=`<div style="background:#1c1c22;border:1px solid #2a2a36;padding:16px 18px;border-radius:12px;min-width:280px;text-align:center">
    <div id="csvmsg" style="margin-bottom:10px">Fetching CSV…</div>
    <div style="height:8px;background:#2a2a36;border-radius:6px;overflow:hidden"><div id="csvbar" style="height:100%;width:0;background:#e2b94b"></div></div>
  </div>`;
  document.body.appendChild(ov);
  const setMsg=t=>ov.querySelector('#csvmsg').textContent=t;
  const setPct=n=>ov.querySelector('#csvbar').style.width=Math.max(0,Math.min(100,n))+'%';
  try{
    const csvText=await (await fetch(CSV_PATH,{cache:'no-cache'})).text();
    const rows=parseCSV(csvText); if(!rows.length){ setMsg('CSV empty'); await sleep(700); return; }
    let done=0;
    for(const r of rows){
      done++; setMsg(`Importing ${done} of ${rows.length}…`); setPct(100*done/rows.length);
      const id=normalizeId(r.id);
      const difficulty=clampInt(r.difficulty,1,5,3);
      const hero=clampInt(r.hero,1,5,3);
      const hiso=clampInt(r.hiso,1,5,3);
      const weight=clampInt(r.weight,0,999,1);
      const exclude=strToBool(r.exclude);
      const name=(r.name||'').trim();
      const category=(r.category||'').trim();
      const desc=(r.desc||'').toString();
      const version=(r.version||'').toString();
      const imgField=(r.image||'').trim();

      meta[id]={...(meta[id]||{}), id, name:name||meta[id]?.name||'Untitled', category:category||meta[id]?.category||'',
        difficulty, hero, hiso, weight, exclude:!!exclude, desc:desc||meta[id]?.desc||'', version};

      if(imgField){
        try{
          const blob=await fetchFirstWorkingBlob(await resolveImageCandidates(imgField));
          if(blob) await storeBlob(id,blob);
        }catch(e){ console.warn('image load fail', imgField, e); }
      }
      await nextFrame();
    }
    saveMeta();
  }finally{
    document.body.removeChild(ov);
  }
}
function parseCSV(text){
  function split(line){
    const cells=[]; let cur='', q=false; for(let i=0;i<line.length;i++){ const ch=line[i], nx=line[i+1];
      if(q){ if(ch==='"'&&nx==='"'){cur+='"';i++;continue;} if(ch==='"'){q=false;continue;} cur+=ch; continue; }
      if(ch==='"'){ q=true; continue; } if(ch===','){ cells.push(cur); cur=''; continue; } cur+=ch;
    } cells.push(cur); return cells;
  }
  const out=[]; const lines=text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n'); if(!lines.length) return out;
  const headers=split(lines.shift());
  for(const line of lines){ if(line.trim()==='') continue; const cols=split(line); const obj={}; headers.forEach((h,i)=>obj[h.trim()]=cols[i]??''); out.push(obj); }
  return out;
}
async function resolveImageCandidates(cell){
  if(/^https?:\/\//i.test(cell)) return [cell];
  const base=cell.replace(/^\.\//,'').trim();
  const parts=base.split('/'); let file=parts.pop()||''; const folder=parts.join('/');
  const name=file.replace(/\.[^.]+$/,''); const ext=(/\.[^.]+$/.exec(file)||[''])[0]; const lower=name.toLowerCase();
  const exts=ext?[ext]:['.jpg','.jpeg','.png','.webp'];
  const folders = folder ? [folder+'/'] : [IMG_BASE, DEFAULT_IMG_BASE, 'images/','assets/positions/'];
  const cands=[]; for(const fo of folders){ for(const e of exts){ cands.push(fo+name+e, fo+lower+e); } }
  cands.unshift(base);
  return cands.map(p=> new URL(p, location.href).href);
}
async function fetchFirstWorkingBlob(urls){
  for(const u of urls){ try{ const r=await fetch(u,{cache:'no-cache'}); if(r.ok){ const b=await r.blob(); if(b&&b.size>0) return b; } }catch(e){} }
  return null;
}
async function storeBlob(id,blob){ try{ await idbPut(id,blob); }catch(e){ memBlobs.set(id,blob); } }
async function getStoredBlob(id){ try{ const rec=await idbGet(id); if(rec&&rec.blob) return rec.blob; }catch(e){} if(memBlobs.has(id)) return memBlobs.get(id); return null; }
function normalizeId(v){ return String(v&&String(v).trim()?v:(crypto.randomUUID?crypto.randomUUID():Date.now()+"-"+Math.random().toString(16).slice(2))); }
function clampInt(v,min,max,def){ const n=parseInt(v,10); return Number.isFinite(n)?Math.min(max,Math.max(min,n)):def; }
function strToBool(x){ const s=String(x||'').trim().toLowerCase(); return s==='1'||s==='true'||s==='yes'||s==='y'; }
const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
const nextFrame=()=>new Promise(r=>requestAnimationFrame(r));

/* boot */
(async function(){
  await openDB(); loadMeta(); loadState();
  $("#oralPill").textContent=state.oralOnly?'ON':'OFF';
  $("#catPill").textContent=state.category;
  $("#diffPill").textContent=state.difficulty || 'All';
  $("#heroPill").textContent=state.hero || 'All';
  $("#hisoPill").textContent=state.hiso || 'All';
  $("#timePill").textContent=state.timerMin? (state.timerMin+'m') : 'Off';
})();
</script>
</body>
</html>
